var sdpUtils=new SdpUtils;function SdpUtils(){function e(){this.iceUfrag="",this.icePwd="",this.iceOptions=""}function t(){this.algorithm="",this.value=""}function m(){this.playload=0,this.codecName="",this.codecInterval="",this.rtcpFB=[],this.fmtp=[]}function u(){this.ssrc=0,this.cname="",this.mslabel="",this.label=""}function h(){this.type="",this.protocol="",this.iceInfo=new e,this.fingerprintInfo=new t,this.setup="",this.mid="",this.msid="",this.extmap={},this.commAbility="",this.rtcpMux=!0,this.rtcpResize=!1,this.codecInfoMap={},this.codecInfoArray=[],this.ssrcInfoMap={},this.ssrcInfoArray=[],this.ssrcGroup=[],this.candidate=[]}function S(){this.version=0,this.username="-",this.sessionID=0,this.sessionVersion=0,this.sessionName="-",this.sessionStartTime=0,this.sessionEndTime=0,this.iceInfo=new e,this.fingerprintInfo=new t,this.group=[],this.wms=[],this.mediaDesc=[]}SdpUtils.prototype.clone=function e(t){if(null==t||"object"!=typeof t)return t;if(t instanceof Date)return(s=new Date).setTime(t.getTime()),s;if(t instanceof Array){for(var s=[],n=t.length,i=0;i<n;++i)s[i]=e(t[i]);return s}if(t instanceof Object){s={};for(var r in t)t.hasOwnProperty(r)&&(s[r]=e(t[r]));return s}throw new Error("Unable to copy obj! Its type isn't supported.")},SdpUtils.prototype.parseSdp=function(e){var t=new S,s=e.split("\r\n"),n=!1,i=null;for(var r in s){switch(s[r].charAt(0)){case"v":t.version=parseInt(s[r].substring(2));break;case"o":var a=s[r].substring(2).split(" ");t.username=a[0],t.sessionID=a[1],t.sessionVersion=a[2];break;case"s":t.sessionName=s[r].substring(2);break;case"t":a=s[r].substring(2).split(" ");t.sessionStartTime=parseInt(a[0]),t.sessionEndTime=parseInt(a[1]);break;case"m":null!=i&&(t.mediaDesc.push(i),i=null);a=s[r].substring(2).split(" ");(i=new h).type=a[0],i.protocol=a[2];for(r=3;r<a.length;++r){(o=new m).playload=parseInt(a[r]),i.codecInfoMap[o.playload]=o,i.codecInfoArray.push(o)}n=!0;break;case"a":if(n){if(-1!=s[r].indexOf("a=ice-ufrag:"))i.iceInfo.iceUfrag=s[r].substring(12);else if(-1!=s[r].indexOf("a=ice-pwd:"))i.iceInfo.icePwd=s[r].substring(10);else if(-1!=s[r].indexOf("a=ice-options:"))i.iceInfo.iceOptions=s[r].substring(14);else if(-1!=s[r].indexOf("a=fingerprint:")){a=s[r].substring(14).split(" ");i.fingerprintInfo.algorithm=a[0],i.fingerprintInfo.value=a[1]}else if(-1!=s[r].indexOf("a=setup:"))i.setup=s[r].substring(8);else if(-1!=s[r].indexOf("a=mid:"))i.mid=s[r].substring(6);else if(-1!=s[r].indexOf("a=extmap:")){a=s[r].substring(9).split(" ");i.extmap[a[0]]=a[1]}else if(-1!=s[r].indexOf("a=rtcp-mux"))i.rtcpMux=!0;else if(-1!=s[r].indexOf("a=rtcp-rsize"))i.rtcpResize=!0;else if(-1!=s[r].indexOf("a=sendrecv")||-1!=s[r].indexOf("a=sendonly")||-1!=s[r].indexOf("a=recvonly")||-1!=s[r].indexOf("a=inactive"))i.commAbility=s[r].substring(2);else if(-1!=s[r].indexOf("a=rtpmap:")){a=s[r].substring(9).split(" ");var o=i.codecInfoMap[a[0]],c=a[1].indexOf("/");a[1].split("/");o.codecName=a[1].substring(0,c),o.codecInterval=a[1].substring(c+1)}else if(-1!=s[r].indexOf("a=rtcp-fb:")){c=s[r].indexOf(" ");var l=s[r].substring(10,c);a=s[r].substring(c+1);(o=i.codecInfoMap[l]).rtcpFB.push(a)}else if(-1!=s[r].indexOf("a=fmtp:")){a=s[r].substring(7).split(" ");(o=i.codecInfoMap[a[0]]).fmtp.push(a[1])}else if(-1!=s[r].indexOf("a=msid:")){var d=s[r].substring(7);i.msid=d}else if(-1!=s[r].indexOf("a=ssrc:")){c=s[r].indexOf(" ");var p=s[r].substring(7,c),f=(a=s[r].substring(c+1).split(":"),i.ssrcInfoMap[p]);f||((f=new u).ssrc=p,i.ssrcInfoArray.push(f)),"cname"==a[0]?f.cname=a[1]:"msid"==a[0]?f.msid=a[1]:"mslabel"==a[0]?f.mslabel=a[1]:"label"==a[0]&&(f.label=a[1]),i.ssrcInfoMap[p]=f}else if(-1!=s[r].indexOf("a=ssrc-group:")){a=s[r].substring(13).split(" ");for(var r in a)i.ssrcGroup.push(a[r])}else if(-1!=s[r].indexOf("a=candidate:")){a=s[r].substring(12);i.candidate.push(a)}}else if(-1!=s[r].indexOf("group:BUNDLE")){var a=s[r].split(" ");for(r=1;r<a.length;++r)t.group.push(a[r])}else if(-1!=s[r].indexOf("msid-semantic:")){var a=s[r].split(" ");t.wms.push(a[a.length-1])}else if(-1!=s[r].indexOf("a=ice-ufrag:"))t.iceInfo.iceUfrag=s[r].substring(12);else if(-1!=s[r].indexOf("a=ice-pwd:"))t.iceInfo.icePwd=s[r].substring(10);else if(-1!=s[r].indexOf("a=ice-options:"))t.iceInfo.iceOptions=s[r].substring(14);else if(-1!=s[r].indexOf("a=fingerprint:")){var a=s[r].substring(14).split(" ");t.fingerprintInfo.algorithm=a[0],t.fingerprintInfo.value=a[1]}}}return null!=i&&(t.mediaDesc.push(i),i=null),t},SdpUtils.prototype.genIceInfoSdp=function(e){var t="";return""!=e.iceUfrag&&(t+="a=ice-ufrag:"+e.iceUfrag+"\r\n"),""!=e.icePwd&&(t+="a=ice-pwd:"+e.icePwd+"\r\n"),""!=e.iceOptions&&(t+="a=ice-options:"+e.iceOptions+"\r\n"),t},SdpUtils.prototype.genFingerprintSdp=function(e){var t="";return""!=e.algorithm&&(t+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"),t},SdpUtils.prototype.genCodecSdp=function(e){var t="";for(var s in t+="a=rtpmap:"+e.playload+" "+e.codecName+"/"+e.codecInterval+"\r\n",e.rtcpFB)t+="a=rtcp-fb:"+e.playload+" "+e.rtcpFB[s]+"\r\n";for(var s in e.fmtp)t+="a=fmtp:"+e.playload+" "+e.fmtp[s]+"\r\n";return t},SdpUtils.prototype.genSSRCSdp=function(e){var t="";return e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),e.msid&&(t+="a=ssrc:"+e.ssrc+" msid:"+e.msid+"\r\n"),e.mslabel&&(t+="a=ssrc:"+e.ssrc+" mslabel:"+e.mslabel+"\r\n"),e.label&&(t+="a=ssrc:"+e.ssrc+" label:"+e.label+"\r\n"),t},SdpUtils.prototype.genMediaSdp=function(e){var t="";t+="m="+e.type+" 9 "+e.protocol;var s="";for(var n in e.codecInfoArray){var i=e.codecInfoArray[n];t+=" "+i.playload,s+=this.genCodecSdp(i)}for(var n in t+="\r\n",t+="c=IN IP4 0.0.0.0\r\n",e.candidate)t+="a=candidate:"+e.candidate[n]+"\r\n";for(var r in 0<e.candidate.length&&(t+="a=end-of-candidates\r\n"),t+="a="+e.commAbility+"\r\n",t+="a=setup:"+e.setup+"\r\n",t+="a=mid:"+e.mid+"\r\n",e.msid&&(t+="a=msid:"+e.msid+"\r\n"),t+=this.genIceInfoSdp(e.iceInfo),t+=this.genFingerprintSdp(e.fingerprintInfo),1==e.rtcpMux&&(t+="a=rtcp-mux\r\n"),1==e.rtcpResize&&(t+="a=rtcp-rsize\r\n"),e.extmap)t+="a=extmap:"+r+" "+e.extmap[r]+"\r\n";for(var n in t+=s,e.ssrcGroup.length&&(t+="a=ssrc-group:FID "+e.ssrcGroup.join(" ")+"\r\n"),e.ssrcInfoArray)t+=this.genSSRCSdp(e.ssrcInfoArray[n]);return t},SdpUtils.prototype.genSdp=function(e){var t="";t+="v="+e.version+"\r\n",t+="o="+e.username+" "+e.sessionID+" "+e.sessionVersion+" IN IP4 127.0.0.1\r\n",t+="s="+e.sessionName+"\r\n",t+="t="+e.sessionStartTime+" "+e.sessionEndTime+"\r\n";var s="",n="";for(var i in e.mediaDesc)n+=" "+e.mediaDesc[i].mid,s+=this.genMediaSdp(e.mediaDesc[i]);return""!=n&&(t+="a=group:BUNDLE"+n+"\r\n"),0!=e.wms.length&&(t+="a=msid-semantic:WMS *\r\n"),t+=this.genIceInfoSdp(e.iceInfo),t+=this.genFingerprintSdp(e.fingerprintInfo),t+=s}}var StarWebRTC=function(){var i=RTCPeerConnection,r=(navigator.mediaDevices.getUserMedia,RTCIceCandidate,RTCSessionDescription),n=(navigator.mozGetUserMedia,{});function e(){this.events={}}function t(){this.localMediaStream=null,this.room="",this.fileData={},this.socket=null,this.me=null,this.peerConnections={},this.connections=[],this.numStreams=0,this.initializedStreams=0,this.dataChannels={},this.fileChannels={},this.receiveFiles={},this.bigStreamId="",this.smallStreamId="",this.audioStreamId="",this.bigSSRC="",this.smallSSRC="",this.audioSSRC="",this.answerSDP="",this.offerSDP={},this.starPeerConnection=null,this.tempPC=null,this.callback=null,this.streamAllsetCallback=null,this.serverIp="0.0.0.0",this.serverPort=80,this.streamInfos=[]}function a(){this.videoId="",this.streamId="",this.bigVideoSSRC=0,this.smallVideoSSRC=0,this.audioSSRC=0,this.streamObj=null,this.switchFlag=!1}return e.prototype.on=function(e,t){this.events[e]=this.events[e]||[],this.events[e].push(t)},e.prototype.emit=function(e,t){var s,n,i=this.events[e],r=Array.prototype.slice.call(arguments,1);if(i)for(s=0,n=i.length;s<n;s++)i[s].apply(null,r)},(t.prototype=new e).destroy=function(){this.emit("_remove_peer")},t.prototype.resetStreamInfos=function(e){this.streamInfos=[];for(var t=0;t<7;++t){var s=new a;s.bigVideoSSRC=2312312300+t,s.smallVideoSSRC=2312311300+t,s.audioSSRC=2312310300+t,s.streamId=this.createRandomString(36),s.cname=this.createRandomString(16),this.streamInfos.push(s)}},t.prototype.init=function(){this.resetStreamInfos();var a=this;this.on("_peers",function(e){a.connections=e.connections,a.me=e.you,a.emit("get_peers",a.connections),a.emit("connected",socket)}),this.on("_remove_peer",function(e){a.closePeerConnection(a.starPeerConnection),delete starPeerConnection,a.bigStreamId="",a.smallStreamId="",a.audioStreamId="",a.bigSSRC="",a.smallSSRC="",a.audioSSRC="",a.answerSDP="",a.offerSDP={},a.starPeerConnection=null,a.callback=null,a.serverIp="0.0.0.0",a.serverPort=80,a.resetStreamInfos()}),this.on("_offer",function(e){a.receiveOffer(e.socketId,e.sdp),a.emit("get_offer",e)}),this.on("_answer",function(e){var t=e.sessionDesc;t.type="answer",t.sdp=t.sdp.replace(/actpass/g,"active"),a.receiveAnswer(e.socketId,t),a.emit("get_answer",e)}),this.on("_webrtc_apply_ok",function(e,t){a.streamAllsetCallback=t;var s="candidate:504457478 1 udp 2122260223 "+a.serverIp+" "+a.serverPort+" typ host generation 0 ufrag Nud3 network-id 1",n=sdpUtils.clone(a.offerSDP);a.createAnswerFromOffer3(n,"Nud3","SKuOCnwS3ScdasO5hD2aheqb",e,a.streamInfos,[s]);var i=sdpUtils.genSdp(n),r={type:"offer"};r.sdp=i,a.starPeerConnection.setRemoteDescription(r).then(function(){a.starPeerConnection.createAnswer(function(e){var t=sdpUtils.parseSdp(e.sdp);a.filterSdpObj(t),a.replaceSSRC(t);var s=sdpUtils.genSdp(t);e.sdp=s,a.starPeerConnection.setLocalDescription(e).then(function(){a.callback({type:"applyAnswer",status:"success"})},function(e){console.log(e),a.callback({type:"applyAnswer",status:"failed"})})},function(e){console.log(e),a.callback({type:"applyAnswer",status:"failed"})})},function(e){console.log(e),a.callback({type:"applyAnswer",status:"failed"})})}),this.on("ready",function(e,t){var s=t||!1;a.callback=e,a.createPeerConnections(),a.addStreams(s),a.sendOffers()})},t.prototype.createStream=function(e,t){var s=this;navigator.mediaDevices.getUserMedia?(this.numStreams++,navigator.mediaDevices.getUserMedia(e).then(function(e){s.localMediaStream=e,s.initializedStreams++,t("success",e)}).catch(function(e){t("failed",e)})):t("failed",new Error("WebRTC is not yet supported in this browser."))},t.prototype.addStreams=function(s){var n=this;this.localMediaStream.getTracks().forEach(function(e){if(n.starPeerConnection.addTrack(e,n.localMediaStream),n.tempPC.addTrack(e,n.localMediaStream),"video"==e.kind){if(n.bigStreamId=e.id,!s){var t=e.clone();n.smallStreamId=t.id,t.applyConstraints({width:{ideal:120},height:{ideal:90},facingMode:{ideal:["user"]}}),n.starPeerConnection.addTrack(t,n.localMediaStream),n.tempPC.addTrack(t,n.localMediaStream)}}else"audio"==e.kind&&(n.audioStreamId=e.id)})},t.prototype.attachStream=function(e,t){document.getElementById(t).srcObject=e},t.prototype.switchStream=function(t){var s=[];t.getVideoTracks().forEach(function(e){s.push(e),t.removeTrack(e)});for(var e=s.length-1;0<=e;e--)t.addTrack(s[e])},t.prototype.switchStreamInfo=function(e){e.switchFlag=!e.switchFlag,this.switchStream(e.streamObj)},t.prototype.resetStreamInfo=function(e){e.switchFlag&&this.switchStreamInfo(e)},t.prototype.switchStreams=function(){for(var e in this.streamInfos)this.switchStreamInfo(this.streamInfos[e])},t.prototype.getStreamByIndex=function(e){return this.streamInfos[e]},t.prototype.getStreamInfos=function(e){return this.streamInfos},t.prototype.onAddStream=function(e){var t=!0;for(var s in this.streamInfos){var n=this.streamInfos[s];n.streamId==e.id&&(n.streamObj=e),null==n.streamObj&&(t=!1)}t&&null!=this.streamAllsetCallback&&"connected"==this.starPeerConnection.iceConnectionState&&(this.streamAllsetCallback(),this.streamAllsetCallback=null)},t.prototype.setServerInfo=function(e){this.serverIp=e.serverIp,this.serverPort=e.serverPort},t.prototype.createRandomString=function(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"],s="",n=0;n<e;++n)s+=t[Math.floor(Math.random()*t.length)];return s},t.prototype.uuid=function(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},t.prototype.replaceSSRC=function(e){for(var t in e.mediaDesc){var s=e.mediaDesc[t];if("audio"==s.type){if(""!=this.audioStreamId&&-1!=s.msid.indexOf(this.audioStreamId)){var n=s.ssrcInfoArray[0];s.ssrcInfoArray=[],s.ssrcInfoMap={},n.ssrc=this.ssrcData.audioSSRC,s.ssrcInfoArray.push(n),s.ssrcInfoMap[n.ssrc]=n}}else if("video"==s.type)if(""!=this.smallStreamId&&-1!=s.msid.indexOf(this.smallStreamId)){n=s.ssrcInfoArray[0];s.ssrcInfoArray=[],s.ssrcInfoMap={},n.ssrc=this.ssrcData.smallVideoSSRC,s.ssrcInfoArray.push(n),s.ssrcInfoMap[n.ssrc]=n}else if(""!=this.bigStreamId&&-1!=s.msid.indexOf(this.bigStreamId)){n=s.ssrcInfoArray[0];s.ssrcInfoArray=[],s.ssrcInfoMap={},n.ssrc=this.ssrcData.bigVideoSSRC,s.ssrcInfoArray.push(n),s.ssrcInfoMap[n.ssrc]=n}}},t.prototype.filterSdpObj=function(e){for(var t in e.mediaDesc){var s=e.mediaDesc[t];s.extmap={},s.ssrcGroup=[],s.codecInfoMap={};var n=[];for(var t in s.codecInfoArray){var i=s.codecInfoArray[t];"audio"==s.type?"opus"==i.codecName&&(n.push(i),s.codecInfoMap[i.playload]=i):"video"==s.type&&"H264"==i.codecName&&0==n.length&&(n.push(i),s.codecInfoMap[i.playload]=i)}s.codecInfoArray=n;var r={},a=[],o={};for(var t in s.ssrcInfoArray){var c=s.ssrcInfoArray[t];null==o[c.label]&&(o[c.label]=1,r[c.ssrc]=c,a.push(c))}s.ssrcInfoArray=a,s.ssrcInfoMap=r}},t.prototype.getSSRCData=function(e,t){var s={audioSSRC:"",smallVideoSSRC:"",bigVideoSSRC:""};for(var n in e.mediaDesc){var i=e.mediaDesc[n];if("audio"==i.type)for(var r in i.ssrcInfoMap){var a=i.ssrcInfoMap[r];s.audioSSRC=a.ssrc}else if("video"==i.type)for(var r in i.ssrcInfoMap){a=i.ssrcInfoMap[r];""!=t.bigStreamId&&(0==a.label.length?-1!=i.msid.indexOf(t.bigStreamId)&&(s.bigVideoSSRC=a.ssrc):-1!=a.label.indexOf(t.bigStreamId)&&(s.bigVideoSSRC=a.ssrc)),""!=t.smallStreamId&&(0==a.label.length?-1!=i.msid.indexOf(t.smallStreamId)&&(s.smallVideoSSRC=a.ssrc):-1!=a.label.indexOf(t.smallStreamId)&&(s.smallVideoSSRC=a.ssrc))}}return s},t.prototype.createAnswerFromOffer3=function(e,t,s,n,i,r){null!=e.iceInfo.iceUfrag&&(e.iceInfo.iceUfrag=t),null!=e.iceInfo.icePwd&&(e.iceInfo.icePwd=s),null!=e.fingerprintInfo.algorithm&&(e.fingerprintInfo.value=n);var a=!1,o=!1,c=[];for(var l in e.mediaDesc){var d=e.mediaDesc[l];if(d.setup="actpass",""!=d.iceInfo.iceUfrag&&(d.iceInfo.iceUfrag=t),""!=d.iceInfo.icePwd&&(d.iceInfo.icePwd=s),""!=d.fingerprintInfo.algorithm&&(d.fingerprintInfo.value=n),d.candidate=r,d.ssrcInfoMap={},d.ssrcInfoArray=[],d.ssrcGroup=[],d.msid="","audio"!=d.type||a){if("video"==d.type&&!o)for(var p in o=!0,i){var f,m;if(0!=i[p].smallVideoSSRC)(f=clone(d)).mid=d.type+"_s"+l+"_"+p,(m={}).ssrc=i[p].smallVideoSSRC,m.cname=i[p].cname,m.mslabel=i[p].streamId,m.label=this.uuid(),m.msid=m.mslabel+" "+m.label,f.ssrcInfoMap[m.ssrc]=m,f.ssrcInfoArray.push(m),f.msid=m.mslabel+" "+m.label,c.push(f);if(0!=i[p].bigVideoSSRC)(f=clone(d)).mid=d.type+"_b"+l+"_"+p,(m={}).ssrc=i[p].bigVideoSSRC,m.cname=i[p].cname,m.mslabel=i[p].streamId,m.label=this.uuid(),m.msid=m.mslabel+" "+m.label,f.ssrcInfoMap[m.ssrc]=m,f.msid=m.mslabel+" "+m.label,f.ssrcInfoArray.push(m),c.push(f)}}else for(var p in a=!0,i){var u=clone(d);u.mid=d.type+"_"+l+"_"+p;var h={};h.ssrc=i[p].audioSSRC,h.cname=i[p].cname,h.mslabel=i[p].streamId,h.label=this.uuid(),h.msid=h.mslabel+" "+h.label,u.ssrcInfoMap[h.ssrc]=h,u.ssrcInfoArray.push(h),u.msid=h.mslabel+" "+h.label,c.push(u)}}e.mediaDesc=c},t.prototype.sendOffers=function(){var i,r=this;this.tempPC.createOffer((this.starPeerConnection,i=this.callback,function(e){var t=sdpUtils.parseSdp(e.sdp);r.filterSdpObj(t);var s=sdpUtils.genSdp(t);r.offerSDP=t,e.sdp=s;var n=r.getSSRCData(t,{bigStreamId:r.bigStreamId,smallStreamId:r.smallStreamId});r.ssrcData=n,r.tempPC.close(),delete r.tempPC,r.tempPC=null,i({type:"createOffer",status:"success",audioSSRC:n.audioSSRC,smallVideoSSRC:n.smallVideoSSRC,bigVideoSSRC:n.bigVideoSSRC})}),function(e){console.log(e),_callback({type:"createOffer",status:"failed",audioSSRC:ssrcData.audioSSRC,smallVideoSSRC:ssrcData.smallVideoSSRC,bigVideoSSRC:ssrcData.bigVideoSSRC})})},t.prototype.receiveOffer=function(e,t){this.starPeerConnection;this.sendAnswer(e,t)},t.prototype.sendAnswer=function(t,e){var s=this.starPeerConnection,n=this;s.setRemoteDescription(new r(e)),s.createAnswer(function(e){s.setLocalDescription(e),n.socket.send(JSON.stringify({eventName:"__answer",data:{socketId:t,sdp:e}}))},function(e){console.log(e)})},t.prototype.receiveAnswer=function(e,t){var s=this.starPeerConnection,n=this;s.setRemoteDescription(new r(t)).then(function(){n.callback({type:"applyAnswer",status:"success"})},function(e){n.callback({type:"applyAnswer",status:"failed"})})},t.prototype.createPeerConnections=function(){this.createPeerConnection("xuaisi")},t.prototype.createPeerConnection=function(e){var t=this,s=new i(n);return this.starPeerConnection=s,this.tempPC=new i(n),s.onicecandidate=function(e){},s.oniceconnectionstatechange=function(e){"connected"===s.iceConnectionState&&null!=t.streamAllsetCallback&&(t.streamAllsetCallback(),t.streamAllsetCallback=null)},s.onopen=function(){t.emit("pc_opened",e,s)},s.onaddstream=function(e){t.onAddStream(e.stream)},s.ondatachannel=function(e){},s},t.prototype.closePeerConnection=function(e){e&&e.close()},t.prototype.broadcast=function(e){var t;for(t in this.dataChannels)this.sendMessage(e,t)},t.prototype.sendMessage=function(e,t){"open"===this.dataChannels[t].readyState.toLowerCase()&&this.dataChannels[t].send(JSON.stringify({type:"__msg",data:e}))},t.prototype.addDataChannels=function(){var e;for(e in this.peerConnections)this.createDataChannel(e)},t.prototype.createDataChannel=function(t,e){var s,n;s=this.peerConnections[t],t||this.emit("data_channel_create_error",t,new Error("attempt to create data channel without socket id")),s instanceof i||this.emit("data_channel_create_error",t,new Error("attempt to create data channel without peerConnection"));try{n=s.createDataChannel(e)}catch(e){this.emit("data_channel_create_error",t,e)}return this.addDataChannel(t,n)},t.prototype.addDataChannel=function(s,n){var i=this;return n.onopen=function(){i.emit("data_channel_opened",n,s)},n.onclose=function(e){delete i.dataChannels[s],i.emit("data_channel_closed",n,s)},n.onmessage=function(e){var t;"__file"===(t=JSON.parse(e.data)).type?i.parseFilePacket(t,s):i.emit("data_channel_message",n,s,t.data)},n.onerror=function(e){i.emit("data_channel_error",n,s,e)},this.dataChannels[s]=n},new t};